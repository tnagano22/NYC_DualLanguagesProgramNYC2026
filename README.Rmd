---
title: "Dual Language Programs in NYC Public Schools between 2017-2024"
author: "Tomonori Nagano"
date: "2024-06-22"
output:
  html_document:
    keep_md: yes
    css: assets/styles.css
---

## Introduction

This analysis compares bilingual/dual language programs available across five boroughs of New York City between 2017-2024.

## Data

<div class="analysis-alt">
<b>My comments</b>: Data about bilingual/dual language programs are available on the NYC Open Data (between 2017-2021) and on the NYC DOE InfoHub (after 2022).
</div>

Raw program lists and LEP language counts are loaded from these project files:

- DOE bilingual/dual language program list for SY 2017-2018 (CSV; DBN-level).
	- `data/raw/anticipated_bilingual_programs_2017_2018.csv`  
	- Source: https://data.cityofnewyork.us/d/ydbx-4ufw  
- DOE bilingual program list for SY 2020-2021
	- `data/raw/bilingual_program_list_2020_2021.csv`  
	- Source: https://data.cityofnewyork.us/d/rrd7-vuvp  
- DOE bilingual program list for SY 2021-2022
	- `data/raw/bilingual_program_list_2021_2022.csv`  
	- Source: https://data.cityofnewyork.us/d/6iwb-7euj
- DOE bilingual program list for SY 2022-2023
	- `data/raw/bilingual-program-list_2022_2023.xlsx`
	- Source (use Internet Archive for the page archive in 2022): https://infohub.nyced.org/in-our-schools/programs/english-language-learners-programs-and-services	
- DOE bilingual program list for SY 2023-2024
	- `data/raw/bilingual-program-list_2023_2024.xlsx`  
	- Source (use Internet Archive for the page archive in 2023): https://infohub.nyced.org/in-our-schools/programs/english-language-learners-programs-and-services
- DOE bilingual program list for SY 2024-2025
	- `data/raw/bilingual-program-list_2024_2025.xlsx`  
	- Source: https://infohub.nyced.org/in-our-schools/programs/english-language-learners-programs-and-services

Data notes:

- File formats vary by year (CSV vs Excel); column names and available fields change across releases.
- The 2017-2018 file uses DBN and requires borough extraction from DBN for borough-level analysis.
- Later years include district/borough fields directly but still need normalization for consistent trend analysis.


## Analysis Scripts

```{r setup, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(dplyr)
library(readr)
library(readxl)
library(stringr)
library(ggplot2)

theme_set(
  theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 13, margin = margin(b = 6)),
      plot.subtitle = element_text(size = 10, margin = margin(b = 8)),
      axis.title = element_text(size = 11),
      axis.text = element_text(color = "#2c2c2c"),
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_blank(),
      legend.position = "bottom",
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 9)
    )
)
```

```{r output-dir, echo=FALSE, message=FALSE}
output_dir <- "output"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}
```

```{r load-programs}
program_2017_2018 <- read_csv("data/raw/anticipated_bilingual_programs_2017_2018.csv")
program_2020_2021 <- read_csv("data/raw/bilingual_program_list_2020_2021.csv")
program_2021_2022 <- read_csv("data/raw/bilingual_program_list_2021_2022.csv")
program_2022_2023 <- read_xlsx("data/raw/bilingual-program-list_2022_2023.xlsx")
program_2023_2024 <- read_xlsx("data/raw/bilingual-program-list_2023_2024.xlsx")
program_2024_2025 <- read_xlsx("data/raw/bilingual-program-list_2024_2025.xlsx")

program_2017_2018 <- program_2017_2018 %>% mutate(SourceYear = "2017-2018")
program_2020_2021 <- program_2020_2021 %>% mutate(SourceYear = "2020-2021")
program_2021_2022 <- program_2021_2022 %>% mutate(SourceYear = "2021-2022")
program_2022_2023 <- program_2022_2023 %>% mutate(SourceYear = "2022-2023")
program_2023_2024 <- program_2023_2024 %>% mutate(SourceYear = "2023-2024")
program_2024_2025 <- program_2024_2025 %>% mutate(SourceYear = "2024-2025")
```

- Data normalization process is omitted in the knit document. See the source RMarkdown for the normaliztaion procedures.
```{r normalize, echo=FALSE, message=FALSE}
clean_names <- function(x) {
  x <- str_trim(x)
  x <- str_replace_all(x, "[^A-Za-z0-9]+", "_")
  x <- str_replace_all(x, "^_|_$", "")
  tolower(x)
}

names(program_2017_2018) <- clean_names(names(program_2017_2018))
names(program_2020_2021) <- clean_names(names(program_2020_2021))
names(program_2021_2022) <- clean_names(names(program_2021_2022))
names(program_2022_2023) <- clean_names(names(program_2022_2023))
names(program_2023_2024) <- clean_names(names(program_2023_2024))
names(program_2024_2025) <- clean_names(names(program_2024_2025))

borough_from_dbn <- function(dbn) {
  borough_code <- str_sub(dbn, 3, 3)
  recode(
    borough_code,
    "M" = "Manhattan",
    "X" = "Bronx",
    "K" = "Brooklyn",
    "Q" = "Queens",
    "R" = "Staten Island",
    .default = NA_character_
  )
}

normalize_language <- function(x) {
  x <- str_squish(x)
  x <- str_replace(
    x,
    regex("^american sign language(.*)$|^sign language \\(american\\)$", ignore_case = TRUE),
    "ASL"
  )
  na_if(x, "")
}

program_2017_2018_norm <- program_2017_2018 %>%
  transmute(
    SourceYear = sourceyear,
    dbn = dbn,
    school_name = school_name,
    program = program,
    language = normalize_language(language),
    district = str_pad(str_sub(dbn, 1, 2), 2, pad = "0"),
    borough = borough_from_dbn(dbn)
  )

program_2020_2021_norm <- program_2020_2021 %>%
  transmute(
    SourceYear = sourceyear,
    dbn = school,
    school_name = school_name,
    program = program,
    language = normalize_language(language),
    district = str_pad(as.character(district), 2, pad = "0"),
    borough = normalize_language(borough)
  )

program_2021_2022_norm <- program_2021_2022 %>%
  transmute(
    SourceYear = sourceyear,
    dbn = school,
    school_name = school_name,
    program = program,
    language = normalize_language(language),
    district = str_pad(as.character(district), 2, pad = "0"),
    borough = normalize_language(borough)
  )

program_2022_2023_norm <- program_2022_2023 %>%
  transmute(
    SourceYear = sourceyear,
    dbn = school,
    school_name = school_name,
    program = program,
    language = normalize_language(language),
    district = str_pad(as.character(district), 2, pad = "0"),
    borough = normalize_language(borough)
  )

program_2023_2024_norm <- program_2023_2024 %>%
  transmute(
    SourceYear = sourceyear,
    dbn = school,
    school_name = school_name,
    program = program,
    language = normalize_language(language),
    district = str_pad(as.character(district), 2, pad = "0"),
    borough = normalize_language(borough)
  )

program_2024_2025_norm <- program_2024_2025 %>%
  transmute(
    SourceYear = sourceyear,
    dbn = school,
    school_name = school_name,
    program = program,
    language = normalize_language(language),
    district = str_pad(as.character(district), 2, pad = "0"),
    borough = normalize_language(borough)
  )

programs_all <- bind_rows(
  program_2017_2018_norm,
  program_2020_2021_norm,
  program_2021_2022_norm,
  program_2022_2023_norm,
  program_2023_2024_norm,
  program_2024_2025_norm
) %>%
  mutate(
    borough_district = if_else(!is.na(borough) & !is.na(district), str_c(borough, "-", district), NA_character_),
    year_start = as.integer(str_sub(SourceYear, 1, 4))
  )
```


<div style="height:40px"></div>
### Overall numbers
<div class="analysis-alt">
<b>My comments</b>: The number of bilingual/dual language programs continued to grow between 2017 and 2024. This was a little bit surprising given a series of setbacks that DOE and bilingual/dual language programs experienced, particularly after 2020, such as COVID-19 and the Times' podcast series "Nice White Parents" in 2020.
</div>

- Count total program rows by year to show overall volume trends.

```{r counts}
program_counts <- programs_all %>%
  count(SourceYear, name = "ProgramRows") %>%
  arrange(SourceYear)

program_counts
```

- Tabulate program rows by language and year, then display the top 5 languages per year.
```{r languages-by-year}
language_by_year <- programs_all %>%
  filter(!is.na(language), !is.na(year_start)) %>%
  count(year_start, language, name = "ProgramRows") %>%
  arrange(year_start, desc(ProgramRows))
```

- Save language-by-year counts to CSV for downstream use.
```{r save-language-by-year}
write_csv(language_by_year, file.path(output_dir, "language_by_year.csv"))
```

- Pivot language counts into a wide year-by-language table.
```{r table-year-language}
language_by_year_table <- language_by_year %>%
  tidyr::pivot_wider(
    names_from = language,
    values_from = ProgramRows,
    values_fill = 0
  ) %>%
  arrange(year_start)
```


<div style="height:40px"></div>
### By languages
<div class="analysis-alt">
<b>My comments</b>: The growth of bilingual/dual language programs (DLP) between 2017 and 2024 is primarily due to the increase in DLP in Spanish. In fact, most languages either lost programs (such as French, Bengali, and Haitian Creole) or lost all programs (such as Hebrew and Japanese). Chinese, which is spoken by about 7% of the total NYC population, did not see much increase during this period. Spanish, which is spoken by about 24% of the total NYC population, is the primary source of the increase in DLP programs over the past decade.
</div>

- Transpose the table to show all languages as rows and years as columns.
```{r table-language-year}
language_by_year_table_t <- language_by_year_table %>%
  tibble::column_to_rownames("year_start") %>%
  t() %>%
  as.data.frame()

language_by_year_table_t
```

- Save the year-by-language table to CSV.
```{r save-year-language}
write_csv(language_by_year_table, file.path(output_dir, "year_by_language.csv"))
```

<div class="analysis-alt">
<b>My comments</b>: If you plot the data, the difference between Spanisn and the other languages becomes more obvious.
</div>

- Plot top languages over time to visualize trends.
```{r languages-by-year-plot}
spanish <- language_by_year %>%
  filter(language == "Spanish")

ggplot(spanish, aes(x = year_start, y = ProgramRows)) +
  geom_line(color = "#1b9e77", linewidth = 1) +
  geom_point(color = "#1b9e77", size = 2) +
  scale_x_continuous(breaks = sort(unique(language_by_year$year_start))) +
  labs(
    title = "Program Rows by Year (Spanish)",
    x = "Year (Start)",
    y = "Program Rows"
  )

language_by_year %>%
  filter(language != "Spanish") %>%
  ggplot(aes(x = year_start, y = ProgramRows, color = language)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = sort(unique(language_by_year$year_start))) +
  scale_color_brewer(palette = "Dark2", na.value = "grey70") +
  labs(
    title = "Program Rows by Language Over Time (All Non-Spanish Languages)",
    x = "Year (Start)",
    y = "Program Rows",
    color = "Language"
  )
```

- Count languages by borough and year, then list top 5 per borough.
```{r languages-by-borough}
language_by_borough <- programs_all %>%
  filter(!is.na(borough), !is.na(language)) %>%
  count(SourceYear, borough, language, name = "ProgramRows") %>%
  arrange(SourceYear, borough, desc(ProgramRows))
```

- Save language-by-borough counts to CSV.
```{r save-language-by-borough}
write_csv(language_by_borough, file.path(output_dir, "language_by_borough.csv"))
```

- Count total program rows by borough over time.
```{r borough-over-time}
borough_by_year <- programs_all %>%
  filter(!is.na(borough), !is.na(year_start)) %>%
  count(year_start, borough, name = "ProgramRows") %>%
  arrange(year_start, borough)
```

- Save borough-by-year counts to CSV.
```{r save-borough-by-year}
write_csv(borough_by_year, file.path(output_dir, "borough_by_year.csv"))
```

<div style="height:40px"></div>
### By boroughs
<div class="analysis-alt">
<b>My comments</b>: In terms of boroughs, Queens has led the growth of bilingual/dual language programs (DLPs) in the past decade. Brooklyn was known as the hub of DLPs until 2020, but its growth has stalled since then (maybe because of the Nice White Parents). The Bronx had a major increase between 2017 and 2020, but it has experienced a declining trend since then (maybe because of COVID-19). It's not entirely clear why Queens never experienced the setback that Brooklyn and the Bronx experienced in 2020. Staten Island has a very small number of DLPs, but the number is slowly increasing.
</div>

- Pivot borough counts into a wide year-by-borough table.
```{r table-year-borough}
borough_by_year_table <- borough_by_year %>%
  tidyr::pivot_wider(
    names_from = borough,
    values_from = ProgramRows,
    values_fill = 0
  ) %>%
  arrange(year_start)

borough_by_year_table
```

- Save the year-by-borough table to CSV.
```{r save-year-borough}
write_csv(borough_by_year_table, file.path(output_dir, "year_by_borough.csv"))
```

- Plot program rows by borough over time.
```{r borough-over-time-plot}
borough_by_year %>%
  filter(borough != "Staten Island") %>%
  ggplot(aes(x = year_start, y = ProgramRows, color = borough)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = sort(unique(borough_by_year$year_start))) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Dual Language Program Rows by Borough Over Time (Excluding Staten Island)",
    x = "Year (Start)",
    y = "Program Rows",
    color = "Borough"
  )
```

```{r borough-over-time-plot-SI}
borough_by_year %>%
  filter(borough == "Staten Island") %>%
  ggplot(aes(x = year_start, y = ProgramRows)) +
  geom_line(linewidth = 1, color = "#4c72b0") +
  geom_point(size = 2, color = "#4c72b0") +
  scale_x_continuous(breaks = sort(unique(borough_by_year$year_start))) +
  labs(
    title = "Dual Language Program Rows by Borough Over Time (Staten Island Only)",
    x = "Year (Start)",
    y = "Program Rows"
  )
```

<div style="height:40px"></div>
### Languages in each borough
<div class="analysis-alt">
<b>My comments</b>: Almost all DLP programs in the Bronx are Spanish (the only non-Spanish DLP in the Bronx is one Bengali DLP). The loss of DLP in the Bronx in the last decade is particularly perplexing since there was a major growth in Spanish DLP overall during the same period. Brooklyn reflects the general trend of DLP in NYC such that there was an increase in Spanish DLP while DLP programs in other languages were lost. Overall, Brooklyn has more DLP programs, but they are less diverse in terms of languages. In Manhattan, there was not much change in the last decade except that there was some increase in Spanish DLP and a decrease in Chinese DLP. Queens has seen a major increase of Spanish DLP â€” there were 77 Spanish DLP in 2017, which grew to 111 in 2024. There has been little change in Staten Island.
</div>

- Plot top languages by borough for the latest year.
```{r languages-by-borough-plot}
years <- sort(unique(language_by_borough$SourceYear))

for (yr in years) {
  plot_data <- language_by_borough %>%
    filter(SourceYear == yr) %>%
    group_by(borough) %>%
    slice_max(ProgramRows, n = 5) %>%
    ungroup()

  p <- ggplot(plot_data, aes(x = reorder(language, ProgramRows), y = ProgramRows, fill = borough)) +
    geom_col(show.legend = FALSE, width = 0.75) +
    coord_flip() +
    facet_wrap(~ borough, scales = "free_y") +
    scale_fill_brewer(palette = "Set2") +
    labs(
      title = paste("Top Languages by Borough (", yr, ")", sep = ""),
      x = "Language",
      y = "Program Rows"
    )

  print(p)
}
```

- Table view of top languages by borough for each year.
```{r languages-by-borough-table}
boroughs <- sort(unique(language_by_borough$borough))

for (b in boroughs) {
  table_data <- language_by_borough %>%
    filter(borough == b) %>%
    select(SourceYear, language, ProgramRows) %>%
    tidyr::pivot_wider(
      names_from = language,
      values_from = ProgramRows,
      values_fill = 0
    ) %>%
    arrange(SourceYear)

  cat("\n\nBorough: ", b, "\n\n", sep = "")
  print(table_data)
}
```

## Output

Outputs are written to `output` and include:

- `language_by_year.csv`
- `year_by_language.csv`
- `language_by_borough.csv`
- `borough_by_year.csv`
- `year_by_borough.csv`
- `language_by_borough_district.csv`
